#ifndef SPEECHBUBBLE_H
#define SPEECHBUBBLE_H

#include "mge/defs.h"
#include "d3re/d3re.h"
#include <string>

#define LOREM_IPSUM "#0000FF#Lorem#FFFFFF# ipsum #FF0000#dolor#FFFFFF# sit #000000#amet#FFFFFF#, consectetur adipiscing #FF00FF#elit#FFFFFF#. In cursus magna a viverra condimentum. Maecenas feugiat nunc vel vulputate porttitor. Nam nec metus lectus. Vestibulum vel #00FFFF#placerat#FFFFFF# justo. Donec sollicitudin #FF00FF#elit#FFFFFF# nec ligula semper lobortis id id lectus. Donec purus ipsum, efficitur #00FF00#vitae#FFFFFF# nisi eget, cursus mollis nisi. Vestibulum ullamcorper eros eget libero malesuada sodales. Aliquam #00FFFF#placerat#FFFFFF# semper risus, id ultrices ipsum. Proin tincidunt #00FFFF#placerat#FFFFFF# #FF00FF#elit#FFFFFF#, a sagittis ante pulvinar ut. Pellentesque blandit varius sapien, vel pharetra sem scelerisque nec. Nulla vel tristique sem. Donec ullamcorper fringilla dui a sodales. Pellentesque sed quam lacus. Etiam porta, ante cursus molestie dictum, #FFFF00#odio#FFFFFF# turpis volutpat sem, vel vestibulum metus libero non purus. Vestibulum eget finibus arcu. Vestibulum congue, ligula sit #000000#amet#FFFFFF# accumsan elementum, nunc turpis rutrum nisl, et ullamcorper felis libero sed #FFFF00#odio#FFFFFF#. Nullam rhoncus #00FF00#vitae#FFFFFF# felis non vehicula. Vivamus #00FF00#vitae#FFFFFF# tempus ipsum. Nam varius vel metus viverra sollicitudin. Donec ornare, erat et sollicitudin iaculis, lectus #FFFF00#odio#FFFFFF# malesuada nisl, sed viverra est massa at diam. Pellentesque fringilla iaculis ipsum, #00FF00#vitae#FFFFFF# egestas augue sodales non. Donec tincidunt ultricies mattis. Etiam eget nunc justo. Nunc bibendum mauris arcu, #00FF00#vitae#FFFFFF# ultricies quam egestas a. Quisque nec dictum justo, at congue felis. Donec cursus orci ac velit tincidunt, a posuere felis facilisis. Praesent quis libero sit #000000#amet#FFFFFF# neque elementum malesuada quis sit #000000#amet#FFFFFF# lectus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Morbi at orci et urna faucibus tempor id vel diam. Sed ultricies egestas pharetra. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Curabitur eget sem sit #000000#amet#FFFFFF# risus tempus suscipit a in diam. Curabitur pharetra nisi sed venenatis vehicula. Suspendisse potenti. Nunc magna arcu, #00FFFF#placerat#FFFFFF# nec lacinia non, fringilla elementum dui. Pellentesque eget turpis fringilla, laoreet quam #00FF00#vitae#FFFFFF#, ultrices sapien. Suspendisse #00FF00#vitae#FFFFFF# leo nec enim vehicula sodales sit #000000#amet#FFFFFF# in mi. Aliquam id ante leo. Phasellus libero #FF00FF#elit#FFFFFF#, fermentum in erat ac, pellentesque venenatis velit. Integer consequat consequat nunc. Curabitur dapibus ac erat #00FFFF#placerat#FFFFFF# vestibulum. Praesent euismod #FF00FF#elit#FFFFFF# non vehicula #00FFFF#placerat#FFFFFF#. Fusce sed #FF00FF#elit#FFFFFF# quam. Fusce sit #000000#amet#FFFFFF# tempor diam. Maecenas quis ultrices augue. Nulla elementum magna risus, vel fermentum ex finibus id. Phasellus iaculis varius mi non semper. Ut nec vehicula erat. Curabitur vestibulum vestibulum dapibus. Quisque finibus sapien nec augue eleifend convallis. Morbi ut auctor ligula. Quisque #FF0000#dolor#FFFFFF# tortor, ullamcorper ac scelerisque quis, facilisis vel magna. Cras et cursus lectus, a blandit sapien. Cras laoreet quam nec felis faucibus, ut semper urna vehicula. Praesent luctus mi quis urna aliquam, id interdum quam porta. Vivamus sit #000000#amet#FFFFFF# nisi in tellus laoreet ornare. Aliquam lobortis aliquam quam. Pellentesque mattis lacinia laoreet. Nulla dapibus purus sed vestibulum accumsan. Maecenas eu eros ac #FF0000#dolor#FFFFFF# sodales posuere ut ut leo. Duis porttitor nibh sed pellentesque facilisis. Vestibulum in lectus in justo pulvinar vulputate. Quisque convallis blandit #0000FF#lorem#FFFFFF# at ornare. In ultricies, nulla dignissim semper mollis, mi erat faucibus #FFFF00#odio#FFFFFF#, #00FF00#vitae#FFFFFF# commodo leo felis varius #0000FF#lorem#FFFFFF#. Fusce ultricies velit a neque accumsan, non elementum ante feugiat. Integer a pretium augue, id eleifend nulla. Quisque #FF0000#dolor#FFFFFF# sem, consectetur sit #000000#amet#FFFFFF# tincidunt ut, gravida eget felis. Cras eleifend ut lacus ac mollis. Maecenas tincidunt tellus sit #000000#amet#FFFFFF# quam bibendum, sit #000000#amet#FFFFFF# viverra purus venenatis. Duis id consectetur diam. Nulla suscipit nisl sed sodales molestie. Vestibulum ac accumsan est, sit #000000#amet#FFFFFF# facilisis #FF0000#dolor#FFFFFF#. Fusce gravida eu urna ac posuere. Nulla lobortis cursus diam non facilisis. Etiam eget fermentum eros, et egestas tortor. Praesent libero nisl, sodales non malesuada sagittis, dapibus eu purus. Vestibulum vestibulum, neque id fringilla volutpat, diam sem suscipit #FF00FF#elit#FFFFFF#, non condimentum turpis nisi sed #FF0000#dolor#FFFFFF#. Etiam rhoncus porta mi nec aliquam. Nulla a justo at sapien dictum vulputate. Donec eget lectus eget nunc pretium volutpat accumsan eget lectus. Nullam non metus id enim imperdiet convallis a nec tortor. Nulla vel nibh et metus eleifend varius et non purus. Phasellus efficitur felis nec scelerisque rhoncus. Duis est nulla, tempus vel facilisis #00FF00#vitae#FFFFFF#, rhoncus nec arcu. Integer lacinia, #0000FF#lorem#FFFFFF# eget sollicitudin venenatis, sem quam porta magna, ac cursus ante massa sed risus. Proin ullamcorper ligula in mi condimentum, ac aliquam nunc pulvinar. Aenean #FF00FF#elit#FFFFFF# nunc, venenatis et ornare id, consectetur a diam. Etiam scelerisque mollis semper. Donec ornare justo ut #FF00FF#elit#FFFFFF# imperdiet, eget sagittis ex sollicitudin. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Fusce vestibulum quam ut mauris hendrerit tincidunt. Nullam a lacinia tortor. Nunc pulvinar nisi aliquam nunc consectetur, ut dapibus diam elementum. Integer pellentesque mollis felis, eu imperdiet ante ultricies eget. Suspendisse quis imperdiet metus, sit #000000#amet#FFFFFF# congue sapien. Morbi sed nulla tellus. Aliquam luctus, libero ut condimentum sagittis, felis nisl sodales #0000FF#lorem#FFFFFF#, vel sagittis est mauris eu sem. Nulla id #FF0000#dolor#FFFFFF# id neque tempus laoreet. Curabitur elementum, turpis at aliquet cursus, urna nulla sagittis arcu, sed vestibulum ante lacus id libero. Nulla rutrum magna #00FF00#vitae#FFFFFF# tincidunt imperdiet. Etiam consequat, ante sit #000000#amet#FFFFFF# interdum vestibulum, lacus purus #00FFFF#placerat#FFFFFF# tellus, at eleifend #0000FF#lorem#FFFFFF# mi ut enim. Fusce aliquam lacus nulla, eget euismod neque finibus #00FF00#vitae#FFFFFF#. Donec in #FF0000#dolor#FFFFFF# ut leo efficitur efficitur blandit eget #FFFF00#odio#FFFFFF#. Nam ac eros a nulla mollis efficitur eu non libero. Morbi mollis, #FF0000#dolor#FFFFFF# eleifend aliquet fermentum, mi libero egestas ex, ut laoreet risus eros in nunc. Maecenas fringilla mi nec nulla interdum, a sodales justo venenatis. Nunc blandit risus dapibus faucibus tincidunt. Etiam semper rutrum elementum. Aliquam eget porttitor tellus. Sed suscipit elementum #FFFF00#odio#FFFFFF#, #00FF00#vitae#FFFFFF# porttitor erat commodo vel. Mauris porta id velit in blandit. Aenean vel purus euismod, lacinia nisi in, ultricies lacus. Vivamus id sodales orci, in ultricies nunc. Mauris nisl tortor, gravida non aliquet consequat, ultrices pretium #FFFF00#odio#FFFFFF#. Mauris metus turpis, consequat vel tellus id, fringilla gravida felis. Cras id euismod #FF00FF#elit#FFFFFF#. Nunc eget elementum #0000FF#lorem#FFFFFF#. Integer tellus #FFFF00#odio#FFFFFF#, hendrerit scelerisque hendrerit #00FF00#vitae#FFFFFF#, posuere nec dui. Sed tincidunt tincidunt sem, at malesuada ante aliquam ut. Etiam pharetra sed nibh id dictum. Aliquam imperdiet orci non #FFFF00#odio#FFFFFF# suscipit, quis ornare quam vulputate. Quisque #00FFFF#placerat#FFFFFF# diam eu sem molestie pulvinar. Fusce dui purus, tristique at #FFFF00#odio#FFFFFF# quis, consequat sodales ante. Nullam euismod finibus mauris, ac egestas mauris sagittis vel. Morbi nec efficitur eros. Aenean #00FFFF#placerat#FFFFFF# eleifend nibh a semper. In non orci aliquet, iaculis orci ac, scelerisque nisi. Ut viverra ligula eget sem imperdiet rhoncus. Suspendisse #00FF00#vitae#FFFFFF# #FF0000#dolor#FFFFFF# velit. Etiam lacinia finibus ipsum, sit #000000#amet#FFFFFF# euismod diam venenatis quis. Cras efficitur ut magna #00FF00#vitae#FFFFFF# ornare. Nulla vehicula fringilla felis, quis ullamcorper arcu gravida nec. Phasellus lobortis metus ac erat varius elementum. Integer aliquet nulla non mauris congue, #00FF00#vitae#FFFFFF# egestas turpis lobortis. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Nam iaculis eget enim a ultrices. Donec sagittis ipsum #00FF00#vitae#FFFFFF# #FF0000#dolor#FFFFFF# convallis, a lacinia ipsum lacinia. Sed nec erat ut #0000FF#lorem#FFFFFF# sollicitudin commodo #00FF00#vitae#FFFFFF# a lacus. Nunc turpis ipsum, ultricies a faucibus #00FF00#vitae#FFFFFF#, dictum #00FF00#vitae#FFFFFF# dui. Etiam varius eros #FFFF00#odio#FFFFFF#, et lobortis augue facilisis sit #000000#amet#FFFFFF#. Duis vel tempus urna, nec pellentesque #FFFF00#odio#FFFFFF#. Curabitur vehicula scelerisque bibendum. Vivamus a bibendum enim. Morbi porta pretium bibendum. Morbi #00FFFF#placerat#FFFFFF# turpis eget mollis convallis. Curabitur convallis est ut mattis pharetra. Cras gravida leo in enim dapibus volutpat. Nullam dignissim, tellus sit #000000#amet#FFFFFF# bibendum lacinia, ex purus sagittis orci, quis congue neque tellus id #FF0000#dolor#FFFFFF#. Cras bibendum urna vehicula, mattis felis vel, feugiat velit. Nulla facilisi. Cras euismod cursus tortor id scelerisque. Nulla ipsum lacus, sagittis sed ultrices non, convallis ac mauris. Donec pretium, enim vel convallis vulputate, diam ipsum varius nisl, sit #000000#amet#FFFFFF# convallis neque neque a #0000FF#lorem#FFFFFF#. Integer vehicula arcu #00FF00#vitae#FFFFFF# feugiat aliquam. Ut ac magna lobortis #FF0000#dolor#FFFFFF# hendrerit finibus quis et turpis. Aliquam bibendum felis eget lacus sagittis, sit #000000#amet#FFFFFF# egestas nisl imperdiet. Suspendisse commodo magna eu risus fermentum, sed dapibus dui facilisis. Vivamus quis semper velit. Sed quis #FF0000#dolor#FFFFFF# enim. Aenean scelerisque a mauris in malesuada. Aliquam erat volutpat. Suspendisse semper eu augue et posuere. Quisque egestas interdum varius. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Donec vulputate, ligula sed posuere commodo, est tortor pharetra ex, quis volutpat nisi risus #00FF00#vitae#FFFFFF# turpis. Vivamus scelerisque ut lacus id vulputate. Aliquam eget #FFFF00#odio#FFFFFF# ac metus sodales semper non viverra nisi. Vestibulum a pharetra nisl. Mauris non sollicitudin augue. Nam cursus urna et pharetra rutrum. Phasellus at fringilla turpis, at pellentesque justo. Nulla eu diam nisl. Integer nec #00FFFF#placerat#FFFFFF# ligula. Ut ornare, sem in malesuada egestas, nisi tortor dignissim lacus, sit #000000#amet#FFFFFF# molestie quam nisi ac ipsum. Nulla in neque ut nibh aliquam malesuada. Interdum et malesuada fames ac ante ipsum primis in faucibus. Cras eget massa neque. Sed maximus eget leo blandit sollicitudin. Aenean tristique dignissim blandit. Ut rutrum commodo imperdiet. Quisque in libero lectus. In elementum ligula ut lobortis pulvinar. Sed enim dui, iaculis tempor scelerisque nec, pulvinar eu libero. Morbi tempor nibh sit #000000#amet#FFFFFF# ex malesuada, quis interdum velit sodales. Mauris #00FFFF#placerat#FFFFFF# pellentesque suscipit. Fusce ac mauris tempor, pharetra lacus non, ultrices ex. Donec eu mauris condimentum, congue lectus posuere, vehicula tellus. Mauris ultricies magna urna, in mollis erat varius eget. Quisque efficitur viverra tortor vel posuere. Sed ex lectus, euismod sit #000000#amet#FFFFFF# tincidunt eu, porttitor sit #000000#amet#FFFFFF# ex. Donec dapibus ante non bibendum commodo. Fusce eget tortor non tellus accumsan bibendum vel et felis. Duis ullamcorper mi eget est semper, eu finibus sem sollicitudin. Praesent semper, leo eu efficitur facilisis, urna lacus fermentum nisl, vel euismod arcu velit sit #000000#amet#FFFFFF# sem. Integer tincidunt finibus est sed feugiat. Sed sed nisi eu leo accumsan imperdiet. Morbi eleifend a nisi ullamcorper varius. Morbi fermentum dignissim magna, ac aliquam tellus venenatis nec. Nulla eu turpis arcu. Etiam ultrices, nibh vel suscipit pulvinar, nulla justo tincidunt metus, sed rhoncus ante ligula molestie purus. Sed tempus ante iaculis lacus laoreet dignissim. Praesent risus nunc, mollis ac fermentum sit #000000#amet#FFFFFF#, dignissim nec turpis. Phasellus vestibulum, sapien ut gravida efficitur, sapien purus aliquet orci, ac aliquam sapien augue sed nisl. Sed faucibus mauris a egestas fermentum. Interdum et malesuada fames ac ante ipsum primis in faucibus. Integer eu feugiat risus. Sed ut eros #FF00FF#elit#FFFFFF#. Integer ex ipsum, interdum et rutrum et, finibus sit #000000#amet#FFFFFF# diam. Integer sit #000000#amet#FFFFFF# felis sit #000000#amet#FFFFFF# est finibus posuere ac vel #0000FF#lorem#FFFFFF#. Sed cursus dui nec diam viverra egestas. Etiam finibus, est sed convallis porta, nisi massa porttitor libero, sit #000000#amet#FFFFFF# elementum ipsum ligula sed est. Maecenas metus leo, luctus eget ornare gravida, suscipit quis enim. Nulla augue #FF00FF#elit#FFFFFF#, tincidunt #00FF00#vitae#FFFFFF# varius eget, mattis in risus. Pellentesque venenatis tristique nunc, nec #00FFFF#placerat#FFFFFF# metus ultrices at. Quisque lacus felis, maximus eu rhoncus #00FF00#vitae#FFFFFF#, viverra eget nisi. Pellentesque gravida enim lectus, nec porttitor sem convallis ut. Integer #00FF00#vitae#FFFFFF# nunc quis sem ultrices lobortis vel ac lectus. In #00FFFF#placerat#FFFFFF# euismod #FFFF00#odio#FFFFFF#."

class SpeechBubble : public D3HudRenderModel
{
public:
    SpeechBubble(uint id, const std::string &msg, const Point &initPos);
    virtual ~SpeechBubble();

    bool update(const Point &pos);
protected:
private:
    enum State {
        SB_OPENING_ANIM,
        SB_SCROLLING_TEXT,
        SB_WAITING_TEXT,
        SB_CLOSING_ANIM,
        SB_DONE
    };
    struct ScrollingCharacterFilter : public TextRenderer::CharacterFilter {
        float m_fCurPos;
        float m_fMaxSize;
        int m_iCurLine;
        uint m_uiLastChar;
        bool m_bIsDone;

        ScrollingCharacterFilter(float fMaxSize, uint length);
        virtual ~ScrollingCharacterFilter();

        virtual float getSize(int index, int adjustedIndex, int line);
        virtual float getOffsetSize(int index, int adjustedIndex, int line);
    };

    uint m_uiId;    //Used for debugging identification
    uint m_uiStateTimer;
    uint m_uiCurFrame;
    State m_eState;
};

#endif // SPEECHBUBBLE_H
